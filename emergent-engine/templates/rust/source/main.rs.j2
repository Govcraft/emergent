//! {{ name_pascal }} Source
//!
//! {{ description }}
//!
//! # Publishes
//!
{% for pub in publishes %}
//! - `{{ pub }}`
{% endfor %}

use emergent_client::helpers::run_source;
use emergent_client::EmergentMessage;
use serde_json::json;
use std::time::Duration;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    run_source(Some("{{ name }}"), |source, mut shutdown| async move {
        let mut interval = tokio::time::interval(Duration::from_secs(1));
        let mut sequence = 0u64;

        loop {
            tokio::select! {
                _ = shutdown.changed() => break,
                _ = interval.tick() => {
                    sequence += 1;
                    let msg = EmergentMessage::new("{{ publishes[0] if publishes else "source.event" }}")
                        .with_payload(json!({"sequence": sequence}));
                    source.publish(msg).await.map_err(|e| e.to_string())?;
                }
            }
        }
        Ok(())
    }).await?;

    Ok(())
}
